// mingo.js 2.1.1
// Copyright (c) 2017 Francis Asante
// MIT
!function(n,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):n.mingo=t()}(this,function(){"use strict";function n(n,t){b(n)&&w(t)}function t(n){switch(u(n)){case Gn:case Xn:return N(n,t);default:return n}}function e(n){switch(u(n)){case Gn:return U([],n);case Xn:return Object.assign({},n);default:return n}}function r(n){return null===n?"Null":void 0===n?"Undefined":n.constructor.name}function u(n){return r(n).toLowerCase()}function i(n){return u(n)===zn}function o(n){return u(n)===Hn}function a(n){return u(n)===Jn}function s(n){return u(n)===Gn}function c(n){return!p(n)&&O(n,"length")}function f(n){return u(n)===Xn}function l(n){return n===Object(n)}function v(n){return u(n)===Kn}function h(n){return u(n)===Wn}function d(n){return u(n)===Zn}function p(n){return $(n)||g(n)}function $(n){return u(n)===Fn}function g(n){return u(n)===Vn}function m(n,t){return n.some(P.bind(null,t))}function y(n,t){return!m(n,t)}function _(n){return!!n}function b(n){return!n}function x(n){return p(n)||s(n)&&0===n.length||f(n)&&0===j(n).length||!n}function k(n){return s(n)?n:[n]}function O(n,t){return n.hasOwnProperty(t)}function w(n){throw new Error(n)}function j(n){return Object.keys(n)}function M(t,e){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;if(n(t===Object(t),"Cannot iterate over object of type '"+u(t)+"'"),c(t))for(var i=0,o=t.length;i<o&&e.call(r,t[i],i,t)!==!1;i++);else for(var a in t)if(O(t,a)&&e.call(r,t[a],a,t)===!1)break}function N(n,t){var e=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;if(s(n))return n.map(t,e);if(f(n)){var r={};return M(n,function(n,u){r[u]=t.call(e,n,u)},n),r}}function A(n,t,e){return s(n)?n.reduce(t,e):(M(n,function(r,u){return e=t(e,r,u,n)}),e)}function I(n,t){return n.filter(m.bind(null,t))}function S(n,t){return U(U([],n),t.filter(y.bind(null,n)))}function E(t){function e(n,t){for(var r=0,i=n.length;r<i;r++)s(n[r])&&(t>0||t<0)?e(n[r],Math.max(-1,t-1)):u.push(n[r])}var r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:-1;n(s(t),"Input must be an Array");var u=[];return e(t,r),u}function D(n,t){if(t<1)return n;for(;t--&&s(n)&&1===n.length;)n=n[0];return n}function P(n,t){for(var e=[n],r=[t];e.length>0;)if(n=e.pop(),t=r.pop(),n!==t){var i=u(n);if(i!==u(t)||i===Zn)return!1;switch(i){case Gn:if(n.length!==t.length)return!1;U(e,n),U(r,t);break;case Xn:var o=j(n),a=j(t);if(o.length!==a.length)return!1;o.sort(),a.sort();for(var s=0,c=o.length;s<c;s++){var f=o[s];if(f!==a[s])return!1;e.push(n[f]),r.push(t[f])}break;default:if(C(n)!==C(t))return!1}}return 0===e.length}function q(n){var t={},e=[];return M(n,function(n){var r=T(n);O(t,r)||(e.push(n),t[r]=0)}),e}function C(n){var t=u(n);switch(t){case zn:case Jn:case Wn:return n.toString();case Hn:return JSON.stringify(n);case Kn:return n.toISOString();case Fn:case Vn:return t;case Gn:return"["+N(n,C)+"]";default:var e=t===Xn?"":""+r(n),i=j(n);return i.sort(),e+"{"+N(i,function(t){return C(t)+":"+C(n[t])})+"}"}}function T(n){for(var t=0,e=C(n),r=e.length;r;)t=(t<<5)-t^e.charCodeAt(--r);return t>>>0}function L(n,t){for(var e=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,r={},u=[],i=n.length,o=[],a=0;a<i;a++){var s=n[a],c=t.call(e,s,a);if(p(c))o.push(s);else{var f=T(s);O(r,f)||(r[f]=[c,a]),u.push(s)}}return u.sort(function(n,t){var e=r[T(n)],u=r[T(t)];return e[0]<u[0]?-1:e[0]>u[0]?1:e[1]<u[1]?-1:e[1]>u[1]?1:0}),U(o,u)}function R(n,t,e){var r={keys:[],groups:[]},u={};return M(n,function(n){var i=t.call(e,n),o=T(i),a=-1;g(u[o])&&(a=r.keys.length,u[o]=a,r.keys.push(i),r.groups.push([])),a=u[o],r.groups[a].push(n)}),r}function U(n,t){return Array.prototype.push.apply(n,t),n}function B(n,t){for(var e=0,r=n.length-1;e<=r;){var u=Math.round(e+(r-e)/2);if(t<n[u])r=u-1;else{if(!(t>n[u]))return u;e=u+1}}return e}function F(n){var t=this;return function(e){return function(){for(var r=arguments.length,u=Array(r),i=0;i<r;i++)u[i]=arguments[i];var o=T(u);return O(e,o)||(e[o]=n.apply(t,u)),e[o]}}({})}function V(n,e){var r=j(e);return 0===r.length?n:n.map(function(n){var u=t(n);return M(r,function(t){var r=Tn(n,e[t]);Pn(u,t,r)}),u})}function Y(t,e){var u=e.boundaries,i=e["default"],o=u[0],a=u[u.length-1],s=e.output||{count:{$sum:1}};n(u.length>2,"$bucket 'boundaries' expression must have at least 3 elements");for(var c=r(o),f=0,l=u.length-1;f<l;f++)n(c===r(u[f+1]),"$bucket 'boundaries' must all be of the same type"),n(u[f]<u[f+1],"$bucket 'boundaries' must be sorted in ascending order");!p(i)&&r(e["default"])===r(o)&&n(o>e["default"]||a<e["default"],"$bucket 'default' expression must be out of boundaries range");var v={};return M(u,function(n){return v[n]=[]}),p(i)||(v[i]=[]),ct.transform(t,function(t){return M(t,function(t){var r=Tn(t,e.groupBy);if(p(r)||r<o||r>=a)n(!p(i),"$bucket require a default for out of range values"),v[i].push(t);else{n(r>=o&&r<a,"$bucket 'groupBy' expression must resolve to a value in range of boundaries");var s=B(u,r),c=u[Math.max(0,s-1)];v[c].push(t)}}),u.pop(),p(i)||u.push(i),u=new ct(u),u.map(function(n){var t=In(v[n],null,s);return Object.assign(t,{_id:n})})})}function z(t,e){var r=e.output||{count:{$sum:1}},u=e.groupBy,i=e.buckets;return n(i>0,"The $bucketAuto 'buckets' field must be greater than 0, but found: "+i),ct.transform(t,function(n){for(var t=Math.max(1,Math.round(n.length/i)),e=F(Tn),o={},a=[],s=L(n,function(n){var t=e(n,u);return p(t)?a.push(n):(o[t]||(o[t]=[]),o[t].push(n)),t}),c=Nn(),f=[],l=0,v=0,h=s.length;v<i&&l<h;v++){for(var d={},$=[],g=0;g<t&&l<h;g++){var m=e(s[l],u);if(p(m)&&(m=null),U($,p(m)?a:o[m]),l+=p(m)?a.length:o[m].length,O(d,"min")||(d.min=m),f.length>0){var y=f[f.length-1];y[c].max=d.min}}v==i-1&&U($,s.slice(l)),f.push(Object.assign(In($,null,r),{_id:d}))}return f.length>0&&(f[f.length-1][c].max=e(s[s.length-1],u)),f})}function J(t,e){n(o(e)&&""!==e.trim()&&e.indexOf(".")===-1&&"$"!==e.trim()[0],"Invalid expression value for $count");var r={};return r[e]=0,t.reduce(function(n,t){return n[e]+=1,n},r).one()}function H(n,t){return ct.transform(n,function(n){return N(t,function(t){return sn(n,t)})}).one()}function K(n,t){var e=Nn(),r=t[e];return ct.transform(n,function(n){var u=R(n,function(n){return Tn(n,r,r)});delete t[e];var i=0,o=u.keys.length;return function(){if(i===o)return ct.done();var n=u.keys[i],r={};return g(n)||(r[e]=n),M(t,function(n,t){r[t]=In(u.groups[i],t,n)}),i++,ct.value(r)}})}function Q(n,t){return n.take(t)}function W(t,r){function u(n){return T(p(n)?null:n)}var i=r.from,a=r.localField,c=r.foreignField,f=r.as;n(s(i)&&o(c)&&o(a)&&o(f),"$lookup: invalid argument");var l={};return M(i,function(n){var t=u(n[c]);l[t]=l[t]||[],l[t].push(n)}),t.map(function(n){var t=u(n[a]),r=e(n);return r[f]=l[t]||[],r})}function G(n,t){var e=new gt(t);return n.filter(function(n){return e.test(n)})}function X(t,e){return n(s(e),"$out: argument must be an array"),t.map(function(n){return e.push(n),n})}function Z(e,r){if(x(r))return e;var u=j(r),i=!1,s=Nn(),c=[!1,!1];if(M(r,function(t,e){e!==s&&(0===t||t===!1?c[0]=!0:c[1]=!0,n(c[0]!==c[1],"Projection cannot have a mix of inclusion and exclusion."))}),m(u,s)){var l=r[s];0!==l&&l!==!1||(u=u.filter(y.bind(null,[s])),n(y(u,s),"Must not contain collections id key"),i=x(u))}else u.push(s);return e.map(function(n){var e={},c=!1,l=!1,v=[];return i&&v.push(s),M(u,function(t){var u=r[t],i=void 0;if(t!==s&&m([0,!1],u)&&(l=!0),t===s&&x(u))i=n[t];else if(o(u))i=Tn(n,u,t);else if(m([1,!0],u));else{if(!f(u))return void v.push(t);var h=j(u);h=!(h.length>1)&&h[0],m(wn(ut),h)?"$slice"===h?k(u[h]).every(a)?(i=ft[h](n,u[h],t),c=!0):i=Tn(n,u,t):i=ft[h](n,u[h],t):i=Tn(n,u,t)}var d=En(n,t);g(d)||Object.assign(e,d),y([0,1,!1,!0],u)&&(g(i)?qn(e,t):Pn(e,t,i))}),(c||l||i)&&(e=Object.assign({},n,e),v.length>0&&(e=t(e),M(v,function(n){return qn(e,n)}))),e})}function nn(n,e){return n.map(function(n){return Un(t(n),e)})}function tn(t,e){return t.map(function(t){return t=Tn(t,e.newRoot),n(f(t),"$replaceRoot expression must return an object"),t})}function en(t,e){var r=e.size;return n(a(r),"$sample size must be a positive integer"),ct.transform(t,function(n){var t=n.length,e=0;return function(){if(e++===r)return ct.done();var u=Math.floor(Math.random()*t);return ct.value(n[u])}})}function rn(n,t){return n.skip(t)}function un(n,t){return!x(t)&&f(t)?ct.transform(n,function(n){var e=j(t);return M(e.reverse(),function(e){var r=R(n,function(n){return Sn(n,e)}),u={},i=L(r.keys,function(n,t){return u[n]=t,n});t[e]===-1&&i.reverse(),n=[],M(i,function(t){return U(n,r.groups[u[t]])})}),n}):n}function on(n,t){var e={count:{$sum:1}};return e[Nn()]=t,this.$sort(this.$group(n,e),{count:-1})}function an(n,t){o(t)&&(t={path:t});var r=t.path.substr(1),u=t.includeArrayIndex||!1,i=t.preserveNullAndEmptyArrays||!1,a=function(n,t){return u!==!1&&(n[u]=t),n},c=void 0;return ct._iter(function(){for(var t=function(){if(ct.isIterator(c)){var t=c.next();if(ct.isVal(t))return{v:t}}var u=n.next();if(ct.isDone(u))return{v:ct.done()};if(u=u.value,c=An(u,r),s(c)){if(0===c.length&&i===!0){c=null;var o=e(u);return delete o[r],{v:{value:a(o,null),done:!1}}}c=new ct(c).map(function(n,t){var i=e(u);return i[r]=n,a(i,t)})}else if(!x(c)||i===!0){var f=a(e(u),null);return{v:{value:f,done:!1}}}};;){var u=t();if("object"===("undefined"==typeof u?"undefined":ot(u)))return u.v}})}function sn(t,e){return n(s(e),"Aggregation pipeline must be an array"),new vt(e).run(t)}function cn(n,t){return q(this.$push(n,t))}function fn(n,t){var e=this.$push(n,t).filter(a),r=A(e,function(n,t){return n+t},0);return r/(e.length||1)}function ln(n,t){return n.length>0?Tn(n[0],t):void 0}function vn(n,t){return n.length>0?Tn(n[n.length-1],t):void 0}function hn(n,t){return A(this.$push(n,t),function(n,t){return p(n)||t>n?t:n},void 0)}function dn(n,t){return A(this.$push(n,t),function(n,t){return p(n)||t<n?t:n},void 0)}function pn(n,t){return p(t)?n:N(n,function(n){return Tn(n,t)})}function $n(n,t){return Rn({data:this.$push(n,t).filter(a),sampled:!1})}function gn(n,t){return Rn({data:this.$push(n,t).filter(a),sampled:!0})}function mn(n,t){return s(n)?a(t)?n.length*t:A(this.$push(n,t).filter(a),function(n,t){return n+t},0):0}function yn(n,t){return r(n)===r(t)}function _n(n,t,e){return new gt(t).find(n,e)}function bn(n,t){return new gt(t).remove(n)}function xn(n,t){return new Array(Math.max(t-String(n).length+1,0)).join("0")+n}function kn(n){if(n<128)return[n];for(var t=n<2048&&1||n<65536&&2||3,e=Nt[t-1],r=[(n>>6*t)+e];t>0;)r.push(128|n>>6*--t&63);return r}function On(n){for(var t=[],e=0,r=n.length;e<r;e++)t.push(kn(n.codePointAt(e)));return t}function wn(){return A(arguments,function(n,t){return U(n,j(St[t]))},[])}function jn(t,e){var r=e(Bn());n(O(St,t),"Invalid operator class "+t);var u=St[t];M(r,function(e,r){n(/^\$\w+$/.test(r),"Invalid operator name "+r),n(!O(u,r),r+" already exists for '"+t+"' operators")});var o={};switch(t){case it:M(r,function(t,e){o[e]=function(t,r){return function(u,o){return{test:function(a){var s=Sn(a,u),c=t.call(r,u,s,o);return n(i(c),e+" must return a boolean"),c}}}}(t,r)});break;case ut:M(r,function(n,t){o[t]=function(n,t){return function(e,r,u){var i=Sn(e,u);return n.call(t,u,i,r)}}(n,r)});break;default:M(r,function(n,t){o[t]=function(n,t){return function(){for(var e=arguments.length,r=Array(e),u=0;u<e;u++)r[u]=arguments[u];return n.apply(t,r)}}(n,r)})}Object.assign(St[t],o)}function Mn(n){Object.assign(Et,n||{})}function Nn(){return Et.key}function An(n,t){return l(n)?n[t]:void 0}function In(t,e,r){if(m(wn(et),e))return ht[e](t,r);if(f(r)){var u={};return M(r,function(e,i){if(u[i]=In(t,i,r[i]),m(wn(et),i))return u=u[i],n(1===j(r).length,"Invalid $group expression '"+JSON.stringify(r)+"'"),!1}),u}}function Sn(n,t,e){function r(n,t){for(var e=n,i=0;i<t.length;i++){var o=t[i],a=null===o.match(/^\d+$/);if(a&&s(e)){if(0===i&&u>0)break;u+=1,t=t.slice(i),e=A(e,function(n,e){var u=r(e,t);return void 0!==u&&n.push(u),n},[]);break}if(e=An(e,o),void 0===e)break}return e}var u=0;return e=e||{meta:!1},n=r(n,t.split(".")),e.meta?{result:n,depth:u}:n}function En(t,e){var r=e.split("."),u=r[0],i=1===r.length||r.slice(1).join("."),o=null!==u.match(/^\d+$/),a=r.length>1,c=void 0,f=void 0;try{s(t)?o?(c=An(t,u),a&&(c=En(c,i)),n(!g(c)),c=[c]):(c=[],M(t,function(n){f=En(n,e),void 0!==f&&c.push(f)}),n(c.length>0)):(f=An(t,u),a&&(f=En(f,i)),n(void 0!==f),c={},c[u]=f)}catch(l){c=void 0}return c}function Dn(n,t,e){var r=arguments.length>3&&void 0!==arguments[3]&&arguments[3],u=t.split("."),i=u[0],o=1===u.length||u.slice(1).join(".");if(1===u.length)e(n,i);else if(s(n)&&!/^\d+$/.test(i))M(n,function(n){Dn(n,t,e,r)});else{if(r===!0){var a=O(n,i);a&&!p(n[i])||(n[i]={})}Dn(n[i],o,e,r)}}function Pn(n,t,e){Dn(n,t,function(n,t){n[t]=e},!0)}function qn(n,t){Dn(n,t,function(n,t){s(n)&&/^\d+$/.test(t)?n.splice(parseInt(t),1):f(n)&&delete n[t]})}function Cn(n){if(m(nt,u(n)))return h(n)?{$regex:n}:{$eq:n};if(l(n)){var t=j(n),e=0===I(wn(it),t).length;if(e)return{$eq:n};if(m(t,"$regex")){var r=n.$regex,i=n.$options||"",a="";o(r)&&(a+=r.ignoreCase||i.indexOf("i")>=0?"i":"",a+=r.multiline||i.indexOf("m")>=0?"m":"",a+=r.global||i.indexOf("g")>=0?"g":"",r=new RegExp(r,a)),n.$regex=r,delete n.$options}}return n}function Tn(t,e){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{};if(i.root=i.root||t,m(wn(tt),r))return It[r](t,e,i);if(m(wn(et),r))return t=Tn(t,e,null,i),n(s(t),r+" expression must resolve to an array"),ht[r](t,null,i);if(o(e)&&e.length>0&&"$"===e[0]){if(m(qt,e))return Dt[e](t,null,i);if(m(Ct,e))return e;var a=qt.filter(function(n){return 0===e.indexOf(n+".")});return 1===a.length&&(a=a[0],"$$ROOT"===a&&(t=i.root),e=e.substr(a.length)),Sn(t,e.slice(1))}switch(u(e)){case Gn:return e.map(function(n){return Tn(t,n)});case Xn:var c={};return M(e,function(r,u){if(c[u]=Tn(t,r,u,i),m(wn(tt,et),u))return n(1===j(e).length,"Invalid aggregation expression '"+JSON.stringify(e)+"'"),c=c[u],!1}),c;default:return e}}function Ln(t,e){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;return p(r)?e<0?(e=Math.max(0,t.length+e),r=t.length-e+1):(r=e,e=0):(e<0&&(e=Math.max(0,t.length+e)),n(r>0,"Invalid argument value for $slice operator. Limit must be a positive number"),r+=e),t.slice(e,r)}function Rn(n){var t=A(n.data,function(n,t){return n+t},0),e=n.data.length||1,r=n.sampled&&1||0,u=t/e;return Math.sqrt(A(n.data,function(n,t){return n+Math.pow(t-u,2)},0)/(e-r))}function Un(n,t){var e=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};e.root=e.root||n;var r=Tn(n,t,null,e);return m(Ct,r)?Pt[r](n,t,e):r}function Bn(){return{assert:n,computeValue:Tn,clone:e,cloneDeep:t,each:M,err:w,getHash:T,getType:r,has:O,idKey:Nn,includes:m.bind(null),isArray:s,isBoolean:i,isDate:v,isEmpty:x,isEqual:P,isFunction:d,isNil:p,isNull:$,isNumber:a,isObject:f,isRegExp:h,isString:o,isUndefined:g,keys:j,map:N,ops:wn,resolve:Sn,resolveObj:En,reduce:A}}var Fn="null",Vn="undefined",Yn="bool",zn="boolean",Jn="number",Hn="string",Kn="date",Qn="regex",Wn="regexp",Gn="array",Xn="object",Zn="function",nt=[Fn,Vn,zn,Jn,Hn,Kn,Wn],tt="expression",et="group",rt="pipeline",ut="projection",it="query",ot="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(n){return typeof n}:function(n){return n&&"function"==typeof Symbol&&n.constructor===Symbol&&n!==Symbol.prototype?"symbol":typeof n},at=function(n,t){if(!(n instanceof t))throw new TypeError("Cannot call a class as a function")},st=function(){function n(n,t){for(var e=0;e<t.length;e++){var r=t[e];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(n,r.key,r)}}return function(t,e,r){return e&&n(t.prototype,e),r&&n(t,r),t}}(),ct=function(){function n(t,e){at(this,n),this.__src=t,this.__fn=e,this.__index=0,this.__done=!1}return st(n,[{key:Symbol.iterator,value:function(){return this}},{key:"_end",value:function(){this.__done=!0,this.__src=null}},{key:"all",value:function(){return n.all(this)}},{key:"next",value:function(){for(var t=n.done();!this.__done&&(n.isIterator(this.__src)?t=this.__src.next():this.__src instanceof Array?this.__index<this.__src.length&&(t={value:this.__src[this.__index++],done:!1}):(t={value:this.__src,done:!1},this._end()),!n.isVal(t)||(this.__fn&&(t=this.__fn(t)),!n.isVal(t)));)n.isDone(t)&&this._end();return t}},{key:"each",value:function(n){this.filter(function(t){n(t)}).all()}},{key:"map",value:function(t){var e=0;return new n(this,function(n){return n.value=t(n.value,e++),n})}},{key:"filter",value:function(t){return new n(this,function(n){if(t(n.value))return n})}},{key:"take",value:function(t){if(n._isfunction(t))return new n(this,function(e){return t(e.value)?e:n.done()});var e=0;return new n(this,function(r){return t>e++?r:n.done()})}},{key:"skip",value:function(t){if(n._isfunction(t))return new n(this,function(n){return t(n.value)?null:n});var e=t;return new n(this,function(n){return 0==e?n:void e--})}},{key:"reduce",value:function(t,e){var r=this;return new n._iter(function(){var u=r.next();if(n.isDone(u))return u;for(var i=0;n.isVal(u);)e=0===i&&void 0===e?u.value:t(e,u.value,i),u=r.next(),i++;return n.value(e)})}},{key:"sample",value:function(){return this.filter(function(n){return Math.random()>.5})}},{key:"reverse",value:function(){return n.transform(this,function(n){return n.reverse(),n})}},{key:"sort",value:function(t){return n.transform(this,function(e){return t=t||n._cmp,e.sort(t),e})}},{key:"sortBy",value:function(t,e){return n.transform(this,function(r){return e=e||n._cmp,r.sort(function(n,r){return e(t(n),t(r))}),r})}},{key:"count",value:function(){return this.reduce(function(n,t){return++n}).all()[0]}},{key:"one",value:function(){var n=this;return{next:function(){return n.next()},all:function(){return n.all()[0]}}}}],[{key:"_cmp",value:function(n,t){return n<t?-1:n>t?1:0}},{key:"_isobject",value:function(n){return!!n&&"Object"===n.constructor.name}},{key:"_isfunction",value:function(n){return n instanceof Function}},{key:"_has",value:function(n,t){return n.hasOwnProperty(t)}},{key:"isDone",value:function(t){return n._isobject(t)&&1===Object.keys(t).length&&n._has(t,"done")&&t.done}},{key:"isVal",value:function(t){return n._isobject(t)&&2===Object.keys(t).length&&n._has(t,"value")&&n._has(t,"done")}},{key:"done",value:function(){return{done:!0}}},{key:"isIterator",value:function(t){return t instanceof Object&&n._isfunction(t.next)}},{key:"value",value:function(n){return{value:n,done:!1}}},{key:"_iter",value:function(t){return t instanceof n?t:(n._isfunction(t)&&(t={next:t}),new n(t))}},{key:"transform",value:function(t,e){return n._iter(e(n.all(t)))}},{key:"all",value:function(t){if(t instanceof Array)return t;if(!n.isIterator(t))return[t];for(var e=[];;){var r=t.next();if(n.isDone(r))break;n.isVal(r)&&e.push(r.value)}return e}},{key:"range",value:function(t,e,r){return void 0===e&&(e=t,t=0),r||(r=t<e?1:-1),new n({next:function(){if(r>0&&t<e||r<0&&t>e){var u=n.value(t);return t+=r,u}return n.done()}})}}]),n}(),ft={$:function(n,t,e){w("$ not implemented")},$elemMatch:function(t,e,r){var u=Sn(t,r),i=new gt(e);n(s(u),"$elemMatch: invalid argument");for(var o=0;o<u.length;o++)if(i.test(u[o]))return[u[o]]},$slice:function(t,e,r){var u=Sn(t,r);return s(u)?s(e)?Ln(u,e[0],e[1]):(n(a(e),"$slice: invalid arguments for projection"),Ln(u,e)):u}},lt={$addFields:V,$bucket:Y,$bucketAuto:z,$count:J,$facet:H,$group:K,$limit:Q,$lookup:W,$match:G,$out:X,$project:Z,$redact:nn,$replaceRoot:tn,$sample:en,$skip:rn,$sort:un,$sortByCount:on,$unwind:an},vt=function(){function t(n){at(this,t),this.__operators=n}return st(t,[{key:"stream",value:function(t,e){return t instanceof ct||(t=new ct(t)),x(this.__operators)||M(this.__operators,function(r){var u=j(r);n(1===u.length&&m(wn(rt),u[0]),"Invalid aggregation operator "+u),u=u[0],t=e&&e instanceof gt?lt[u].call(e,t,r[u]):lt[u](t,r[u])}),t}},{key:"run",value:function(n,t){return this.stream(n,t).all()}}]),t}(),ht={$addToSet:cn,$avg:fn,$first:ln,$last:vn,$max:hn,$min:dn,$push:pn,$stdDevPop:$n,$stdDevSamp:gn,$sum:mn},dt=function(){function n(t,e,r){at(this,n),this.__query=e,this.__source=t,this.__projection=r||e.__projection,this.__operators=[],this.__result=null,this.__stack=[]}return st(n,[{key:"_fetch",value:function(){var n=this;return this.__result?this.__result:(f(this.__projection)&&this.__operators.push({$project:this.__projection}),this.__result=new ct(this.__source).filter(function(t){return n.__query.test(t)}),this.__operators.length>0&&(this.__result=new vt(this.__operators).stream(this.__result,this.__query)),this.__result)}},{key:"all",value:function(){return this._fetch().all()}},{key:"count",value:function(){return this.all().length}},{key:"skip",value:function(n){return this.__operators.push({$skip:n}),this}},{key:"limit",value:function(n){return this.__operators.push({$limit:n}),this}},{key:"sort",value:function(n){return this.__operators.push({$sort:n}),this}},{key:"next",value:function(){if(this.__stack){if(this.__stack.length>0)return this.__stack.pop();var n=this._fetch().next();return ct.isVal(n)?n.value:void(this.__stack=null)}}},{key:"hasNext",value:function(){if(!this.__stack)return!1;if(this.__stack.length>0)return!0;var n=this._fetch().next();return ct.isVal(n)?this.__stack.push(n.value):this.__stack=null,!!this.__stack}},{key:"map",value:function(n){return this._fetch().map(n).all()}},{key:"forEach",value:function(n){this._fetch().each(n)}},{key:Symbol.iterator,value:function(){return this._fetch()}}]),n}(),pt={$eq:function(n,t){if(P(n,t))return!0;if(p(n)&&p(t))return!0;if(s(n)){var e=P.bind(null,t);return n.some(e)||E(n,1).some(e)}return!1},$ne:function(n,t){return!this.$eq(n,t)},$in:function(n,t){return I(k(n),t).length>0},$nin:function(n,t){return p(n)||!this.$in(n,t)},$lt:function(n,t){return!g(k(n).find(function(n){return yn(n,t)&&n<t}))},$lte:function(n,t){return!g(k(n).find(function(n){return yn(n,t)&&n<=t}))},$gt:function(n,t){return!g(k(n).find(function(n){return yn(n,t)&&n>t}))},$gte:function(n,t){return!g(k(n).find(function(n){return yn(n,t)&&n>=t}))},$mod:function(n,t){return!g(k(n).find(function(n){return a(n)&&s(t)&&2===t.length&&n%t[0]===t[1]}))},$regex:function(n,t){n=k(n);var e=function(n){return o(n)&&!!n.match(t)};return n.some(e)||E(n,1).some(e)},$exists:function(n,t){return(t===!1||0===t)&&p(n)||(t===!0||1===t)&&!p(n)},$all:function(n,t){var e=!1;if(s(n)&&s(t))for(var r=0,u=t.length;r<u;r++){if(!f(t[r])||!m(j(t[r]),"$elemMatch"))return I(t,n).length===u;e=e||this.$elemMatch(n,t[r].$elemMatch)}return e},$size:function(n,t){return s(n)&&a(t)&&n.length===t},$elemMatch:function(n,t){if(s(n)&&!x(n))for(var e=new gt(t),r=0,u=n.length;r<u;r++)if(e.test(n[r]))return!0;return!1},$type:function(n,t){switch(t){case 1:case"double":return a(n)&&(n+"").indexOf(".")!==-1;case 2:case Hn:return o(n);case 3:case Xn:return f(n);case 4:case Gn:return s(n);case 6:case Vn:return p(n);case 8:case Yn:return i(n);case 9:case Kn:return v(n);case 10:case Fn:return $(n);case 11:case Qn:return h(n);case 16:case"int":return a(n)&&n<=2147483647&&(n+"").indexOf(".")===-1;case 18:case"long":return a(n)&&n>2147483647&&n<=0x8000000000000000&&(n+"").indexOf(".")===-1;case 19:case"decimal":return a(n);default:return!1}}},$t={$and:function(t,e){n(s(e),"Invalid expression: $and expects value to be an Array");var r=[];return M(e,function(n){return r.push(new gt(n))}),{test:function(n){for(var t=0;t<r.length;t++)if(!r[t].test(n))return!1;return!0}}},$or:function(t,e){n(s(e),"Invalid expression. $or expects value to be an Array");var r=[];return M(e,function(n){return r.push(new gt(n))}),{test:function(n){for(var t=0;t<r.length;t++)if(r[t].test(n))return!0;return!1}}},$nor:function(t,e){n(s(e),"Invalid expression. $nor expects value to be an Array");var r=this.$or("$or",e);return{test:function(n){return!r.test(n)}}},$not:function(n,t){var e={};e[n]=Cn(t);var r=new gt(e);return{test:function(n){return!r.test(n)}}},$where:function(n,t){return d(t)||(t=new Function("return "+t+";")),{test:function(n){return t.call(n)===!0}}}};M(pt,function(n,t){$t[t]=function(n,t){return function(e,r){return{test:function(u){var i=Sn(u,e,{meta:!0});return i=D(i.result,i.depth),n.call(t,i,r)}}}}(n,pt)});var gt=function(){function t(n){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};at(this,t),this.__criteria=n,this.__projection=e,this.__compiled=[],this._compile()}return st(t,[{key:"_compile",value:function(){var t=this;if(!x(this.__criteria)){n(f(this.__criteria),"Criteria must be of type Object");var e=void 0;M(this.__criteria,function(n,r){"$where"===r?e={field:r,expr:n}:m(["$and","$or","$nor"],r)?t._processOperator(r,r,n):(n=Cn(n),M(n,function(n,e){t._processOperator(r,e,n)})),f(e)&&t._processOperator(e.field,e.field,e.expr)})}}},{key:"_processOperator",value:function(t,e,r){n(m(wn(it),e),"Invalid query operator '"+e+"' detected"),this.__compiled.push($t[e](t,r))}},{key:"test",value:function(n){for(var t=0,e=this.__compiled.length;t<e;t++)if(!this.__compiled[t].test(n))return!1;return!0}},{key:"find",value:function(n,t){return new dt(n,this,t)}},{key:"remove",value:function(n){var t=this;return A(n,function(n,e){return t.test(e)||n.push(e),n},[])}}]),t}(),mt={$abs:function(n,t){var e=Tn(n,t);return null===e||void 0===e?null:Math.abs(e)},$add:function(t,e){var r=Tn(t,e),u=!1,i=A(r,function(t,e){return v(e)&&(n(!u,"'$add' can only have one date value"),u=!0,e=e.getTime()),t+=e},0);return u?new Date(i):i},$ceil:function(t,e){var r=Tn(t,e);return p(r)?null:(n(a(r)||isNaN(r),"$ceil must be a valid expression that resolves to a number."),Math.ceil(r))},$divide:function(n,t){var e=Tn(n,t);return e[0]/e[1]},$exp:function(t,e){var r=Tn(t,e);return p(r)?null:(n(a(r)||isNaN(r),"$exp must be a valid expression that resolves to a number."),Math.exp(r))},$floor:function(t,e){var r=Tn(t,e);return p(r)?null:(n(a(r)||isNaN(r),"$floor must be a valid expression that resolves to a number."),Math.floor(r))},$ln:function(t,e){var r=Tn(t,e);return p(r)?null:(n(a(r)||isNaN(r),"$ln must be a valid expression that resolves to a number."),Math.log(r))},$log:function(t,e){var r=Tn(t,e);return n(s(r)&&2===r.length,"$log must be a valid expression that resolves to an array of 2 items"),r.some(p)?null:(n(r.some(isNaN)||r.every(a),"$log expression must resolve to array of 2 numbers"),Math.log10(r[0])/Math.log10(r[1]))},$log10:function(t,e){var r=Tn(t,e);return p(r)?null:(n(a(r)||isNaN(r),"$log10 must be a valid expression that resolves to a number."),Math.log10(r))},$mod:function(n,t){var e=Tn(n,t);return e[0]%e[1]},$multiply:function(n,t){var e=Tn(n,t);return A(e,function(n,t){return n*t},1)},$pow:function(t,e){var r=Tn(t,e);return n(s(r)&&2===r.length&&r.every(a),"$pow expression must resolve to an array of 2 numbers"),n(!(0===r[0]&&r[1]<0),"$pow cannot raise 0 to a negative exponent"),Math.pow(r[0],r[1])},$sqrt:function(t,e){var r=Tn(t,e);return p(r)?null:(n(a(r)&&r>0||isNaN(r),"$sqrt expression must resolve to non-negative number."),Math.sqrt(r))},$subtract:function(n,t){var e=Tn(n,t);return e[0]-e[1]},$trunc:function(t,e){var r=Tn(t,e);return p(r)?null:(n(a(r)||isNaN(r),"$trunc expression must resolve to a number."),Math.trunc(r))}},yt={$arrayElemAt:function(t,e){var r=Tn(t,e);n(s(r)&&2===r.length,"$arrayElemAt expression must resolve to an array of 2 elements"),n(s(r[0]),"First operand to $arrayElemAt must resolve to an array"),n(a(r[1]),"Second operand to $arrayElemAt must resolve to an integer");var u=r[1];return r=r[0],u<0&&Math.abs(u)<=r.length?r[u+r.length]:u>=0&&u<r.length?r[u]:void 0},$arrayToObject:function(t,e){var r=Tn(t,e);return n(s(r),"$arrayToObject expression must resolve to an array"),A(r,function(t,e){return s(e)&&2==e.length?t[e[0]]=e[1]:(n(f(e)&&O(e,"k")&&O(e,"v"),"$arrayToObject expression is invalid."),t[e.k]=e.v),t},{})},$concatArrays:function(t,e){var r=Tn(t,e,null);return n(s(r),"$concatArrays must resolve to an array"),r.some(p)?null:r.reduce(function(n,t){return U(n,t)},[])},$filter:function(t,e){var r=Tn(t,e.input),u=e.as,i=e.cond;return n(s(r),"$filter 'input' expression must resolve to an array"),r.filter(function(n){var t={};return t["$"+u]=n,Tn(t,i)===!0})},$in:function(t,e){var r=Tn(t,e[0]),u=Tn(t,e[1]);return n(s(u),"$in second argument must be an array"),m(u,r)},$indexOfArray:function(t,e){var r=Tn(t,e);if(p(r))return null;var u=r[0],i=r[1];if(p(u))return null;n(s(u),"$indexOfArray expression must resolve to an array.");var o=r[2]||0,a=r[3];return p(a)&&(a=u.length),o>a?-1:(n(o>=0&&a>=0,"$indexOfArray expression is invalid"),(o>0||a<u.length)&&(u=u.slice(o,a)),u.findIndex(P.bind(null,i))+o)},$isArray:function(n,t){return s(Tn(n,t[0]))},$map:function(t,e){var r=Tn(t,e.input);n(s(r),"$map 'input' expression must resolve to an array");var u=e.as,i=e["in"],o="$"+u;return N(r,function(n){return t[o]=n,Tn(t,i)})},$objectToArray:function(t,e){var r=Tn(t,e);n(f(r),"$objectToArray expression must resolve to an object");var u=[];return M(r,function(n,t){return u.push({k:t,v:n})}),u},$range:function(n,t){for(var e=Tn(n,t),r=e[0],u=e[1],i=e[2]||1,o=[];r<u&&i>0||r>u&&i<0;)o.push(r),r+=i;return o},$reduce:function(t,e){var r=Tn(t,e.input),u=Tn(t,e.initialValue),i=e["in"];return p(r)?null:(n(s(r),"$reduce 'input' expression must resolve to an array"),A(r,function(n,t){return Tn({$value:n,$this:t},i)},u))},$reverseArray:function(t,e){var r=Tn(t,e);if(p(r))return null;n(s(r),"$reverseArray expression must resolve to an array");var u=[];return U(u,r),u.reverse(),u},$size:function(n,t){var e=Tn(n,t);return s(e)?e.length:void 0},$slice:function(n,t){var e=Tn(n,t);return Ln(e[0],e[1],e[2])},$zip:function(t,e){var r=Tn(t,e.inputs),u=e.useLongestLength||!1;n(s(r),"'inputs' expression must resolve to an array"),n(i(u),"'useLongestLength' must be a boolean"),s(e.defaults)&&n(_(u),"'useLongestLength' must be set to true to use 'defaults'");for(var o=0,a=0,c=r.length;a<c;a++){var f=r[a];if(p(f))return null;n(s(f),"'inputs' expression values must resolve to an array or null"),o=u?Math.max(o,f.length):Math.min(o||f.length,f.length)}for(var l=[],v=e.defaults||[],h=function(n){var t=r.map(function(t,e){return p(t[n])?v[e]||null:t[n]});l.push(t)},d=0;d<o;d++)h(d);return l}},_t={$and:function(n,t){var e=Tn(n,t);return _(e)&&e.every(_)},$or:function(n,t){var e=Tn(n,t);return _(e)&&e.some(_)},$not:function(n,t){return!Tn(n,t[0])}},bt={$cmp:function(n,t){var e=Tn(n,t);return e[0]>e[1]?1:e[0]<e[1]?-1:0}};M(["$eq","$ne","$gt","$gte","$lt","$lte","$nin"],function(n){bt[n]=function(t,e){var r=Tn(t,e);return pt[n](r[0],r[1])}});var xt={$cond:function(t,e){var r=void 0,u=void 0,i=void 0,o="$cond: invalid arguments";s(e)?(n(3===e.length,o),r=e[0],u=e[1],i=e[2]):(n(f(e),o),r=e["if"],u=e.then,i=e["else"]);var a=Tn(t,r);return a?Tn(t,u):Tn(t,i)},$switch:function(t,e){var r="Invalid arguments for $switch operator";n(e.branches,r);var u=e.branches.find(function(e){return n(e["case"]&&e.then,r),Tn(t,e["case"])});return u?Tn(t,u.then):(n(e["default"],r),Tn(t,e["default"]))},$ifNull:function(t,e){n(s(e)&&2===e.length,"Invalid arguments for $ifNull operator");var r=Tn(t,e);return p(r[0])?r[1]:r[0]}},kt={"%Y":["$year",4],"%m":["$month",2],"%d":["$dayOfMonth",2],"%H":["$hour",2],"%M":["$minute",2],"%S":["$second",2],"%L":["$millisecond",3],"%j":["$dayOfYear",3],"%w":["$dayOfWeek",1],"%U":["$week",2],"%%":"%"},Ot={$dayOfYear:function(n,t){var e=Tn(n,t),r=new Date(e.getFullYear(),0,0),u=e-r,i=864e5;return Math.round(u/i)},$dayOfMonth:function(n,t){var e=Tn(n,t);return e.getDate()},$dayOfWeek:function(n,t){var e=Tn(n,t);return e.getDay()+1},$year:function(n,t){var e=Tn(n,t);return e.getFullYear()},$month:function(n,t){var e=Tn(n,t);return e.getMonth()+1},$week:function(n,t){var e=Tn(n,t);e=new Date((+e)),e.setHours(0,0,0),e.setDate(e.getDate()+4-(e.getDay()||7));var r=new Date(e.getFullYear(),0,1);return Math.floor(((e-r)/864e5+1)/7)},$hour:function(n,t){var e=Tn(n,t);return e.getUTCHours()},$minute:function(n,t){var e=Tn(n,t);return e.getMinutes();
},$second:function(n,t){var e=Tn(n,t);return e.getSeconds()},$millisecond:function(n,t){var e=Tn(n,t);return e.getMilliseconds()},$dateToString:function(n,t){for(var e=t.format,r=Tn(n,t.date),u=e.match(/(%%|%Y|%m|%d|%H|%M|%S|%L|%j|%w|%U)/g),i=0,o=u.length;i<o;i++){var a=kt[u[i]],c=a;if(s(a)){var f=this[a[0]],l=a[1];c=xn(f.call(this,n,r),l)}e=e.replace(u[i],c)}return e}},wt={$literal:function(n,t){return t}},jt={$setEquals:function(n,t){var e=Tn(n,t),r=q(e[0]),u=q(e[1]);return r.length===u.length&&r.length===I(r,u).length},$setIntersection:function(n,t){var e=Tn(n,t);return I(e[0],e[1])},$setDifference:function(n,t){var e=Tn(n,t);return e[0].filter(y.bind(null,e[1]))},$setUnion:function(n,t){var e=Tn(n,t);return S(e[0],e[1])},$setIsSubset:function(n,t){var e=Tn(n,t);return I(e[0],e[1]).length===e[0].length},$anyElementTrue:function(n,t){var e=Tn(n,t)[0];return e.some(_)},$allElementsTrue:function(n,t){var e=Tn(n,t)[0];return e.every(_)}},Mt={$concat:function(n,t){var e=Tn(n,t);return[null,void 0].some(m.bind(null,e))?null:e.join("")},$indexOfBytes:function(t,e){var r=Tn(t,e),u="$indexOfBytes: expression resolves to invalid arguments";if(p(r[0]))return null;n(o(r[0])&&o(r[1]),u);var i=r[0],s=r[1],c=r[2],f=r[3],l=p(c)||a(c)&&c>=0&&Math.round(c)===c;if(l=l&&(p(f)||a(f)&&f>=0&&Math.round(f)===f),n(l,u),c=c||0,f=f||i.length,c>f)return-1;var v=i.substring(c,f).indexOf(s);return v>-1?v+c:v},$split:function(t,e){var r=Tn(t,e);return p(r[0])?null:(n(r.every(o),"$split: invalid argument"),r[0].split(r[1]))},$strLenBytes:function(n,t){return~-encodeURI(Tn(n,t)).split(/%..|./).length},$strLenCP:function(n,t){return Tn(n,t).length},$strcasecmp:function(t,e){var r=Tn(t,e),u=r[0],i=r[1];return P(u,i)||r.every(p)?0:(n(r.every(o),"$strcasecmp: invalid argument"),u=u.toUpperCase(),i=i.toUpperCase(),u>i&&1||u<i&&-1||0)},$substrBytes:function(t,e){var r=Tn(t,e),u=r[0],i=r[1],s=r[2];n(o(u)&&a(i)&&i>=0&&a(s)&&s>=0,"$substrBytes: invalid arguments");for(var c=On(u),f=[],l=0,v=0;v<c.length;v++)f.push(l),l+=c[v].length;var h=f.indexOf(i),d=f.indexOf(i+s);return n(h>-1&&d>-1,"$substrBytes: Invalid range, start or end index is a UTF-8 continuation byte."),u.substring(h,d)},$substr:function(n,t){var e=Tn(n,t),r=e[0],u=e[1],i=e[2];return o(r)?u<0?"":i<0?r.substr(u):r.substr(u,i):""},$substrCP:function(n,t){return this.$substr(n,t)},$toLower:function(n,t){var e=Tn(n,t);return x(e)?"":e.toLowerCase()},$toUpper:function(n,t){var e=Tn(n,t);return x(e)?"":e.toUpperCase()}},Nt=[192,224,240],At={$let:function(n,t){var e=t.vars,r=t["in"],u=j(e);return M(u,function(t){var r=Tn(n,e[t]),u="$"+t;n[u]=r}),Tn(n,r)}},It=Object.assign({},mt,yt,_t,bt,xt,Ot,wt,jt,Mt,At),St={expression:It,group:ht,pipeline:lt,projection:ft,query:$t},Et={key:"_id"},Dt={$$ROOT:function(n,t,e){return e.root},$$CURRENT:function(n,t,e){return n}},Pt={$$KEEP:function(n){return n},$$PRUNE:function(){},$$DESCEND:function(n,t,e){if(!O(t,"$cond"))return n;var r=void 0;return M(n,function(u,i){l(u)&&(s(u)?(r=[],M(u,function(n){f(n)&&(n=Un(n,t,e)),p(n)||r.push(n)})):r=Un(u,t,e),p(r)?delete n[i]:n[i]=r)}),n}},qt=j(Dt),Ct=j(Pt),Tt={query:function(n,t){return new gt(n).find(this.toJSON(),t)},aggregate:function(n){return new vt(n).run(this.toJSON())}},Lt="2.1.1",Rt={_internal:Bn,Aggregator:vt,CollectionMixin:Tt,Cursor:dt,Lazy:ct,OP_EXPRESSION:tt,OP_GROUP:et,OP_PIPELINE:rt,OP_PROJECTION:ut,OP_QUERY:it,Query:gt,VERSION:Lt,addOperators:jn,aggregate:sn,find:_n,remove:bn,setup:Mn};return Rt});
//# sourceMappingURL=dist/mingo.min.map
